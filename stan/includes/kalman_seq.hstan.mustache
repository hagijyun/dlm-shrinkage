#define KALMAN_SEQ_{{tv_T}}{{tv_Z}}{{tv_H}}{{tv_RQR}}{{tv_c}}{{tv_d}}{{use_missing}}(y, T, Z, H, RQR, a1, P1, c, d{{#use_missing}}, missing{{/use_missing}}) \
{ \
  real KALMAN_SEQ_v; \
  vector[rows(T)] KALMAN_SEQ_K; \
  real KALMAN_SEQ_Finv; \
  vector[rows(T)] KALMAN_SEQ_a; \
  matrix[rows(T), rows(T)] KALMAN_SEQ_P; \
  vector[rows(T)] KALMAN_SEQ_M; \
  real KALMAN_SEQ_F; \
  KALMAN_SEQ_a <- a1; \
  KALMAN_SEQ_P <- P1; \
  for (i in 1:dims(y)[1]) { \
    for (j in 1:dims(y)[2]) { \
      {{#use_missing}} \
      if (! int_step(missing[i, j])) { \
      {{/use_missing}} \
        vector[m] KALMAN_SEQ_Zj; \
        KALMAN_SEQ_Zj <- Z[{{#tv_c}}i, {{/tv_c}}j]'; \
        KALMAN_SEQ_v <- y[i, j] - c[{{#tv_c}}i, {{/tv_c}}j] - dot_product(KALMAN_SEQ_Zj, KALMAN_SEQ_a); \
        KALMAN_SEQ_M <- KALMAN_SEQ_P * KALMAN_SEQ_Zj; \
        KALMAN_SEQ_F <- dot_product(KALMAN_SEQ_Zj, KALMAN_SEQ_M) + H[{{#tv_H}}i, {{/tv_H}}j]; \
        KALMAN_SEQ_Finv <- 1 / KALMAN_SEQ_F; \
        KALMAN_SEQ_K <- KALMAN_SEQ_M * KALMAN_SEQ_Finv; \
        KALMAN_SEQ_a <- KALMAN_SEQ_a + KALMAN_SEQ_K * KALMAN_SEQ_v; \
        KALMAN_SEQ_P <- KALMAN_SEQ_P - KALMAN_SEQ_K * KALMAN_SEQ_M'; \
        KALMAN_SEQ_P <- 0.5 * (KALMAN_SEQ_P + KALMAN_SEQ_P');  \
        lp__ <- lp__  - 0.5 * (log(2 * pi())  \
                               + log(KALMAN_SEQ_F) + KALMAN_SEQ_Finv * pow(KALMAN_SEQ_v, 2.0)); \
      {{#use_missing}} \
      } \
      {{/use_missing}} \
    } \
    KALMAN_SEQ_a <- d{{#tv_d}}[i]{{/tv_d}} + T{{#tv_T}}[i]{{/tv_T}} * KALMAN_SEQ_a; \
    KALMAN_SEQ_P <- T{{#tv_T}}[i]{{/tv_T}} * KALMAN_SEQ_P * T{{#tv_T}}[i]{{/tv_T}}' + RQR{{#tv_RQR}}[i]{{/tv_RQR}}; \
    KALMAN_SEQ_P <- 0.5 * (KALMAN_SEQ_P + KALMAN_SEQ_P'); \
  } \
} \

